generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma"
  engineType = "client"
  runtime    = "bun"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

enum UserRole {
  user
  admin
}

enum AccountType {
  cash
  bank
  credit_card
  investment
}

enum CategoryType {
  expense
  income
  transfer
  investment
  loan
}

enum TransactionType {
  income
  expense
  transfer
  loan_given
  loan_received
  repay_debt
  collect_debt
  investment
}

enum InvestmentAssetType {
  coin
  ccq
  custom
}

enum InvestmentMode {
  priced
  manual
}

enum EntityType {
  individual
  organization
}

enum BudgetPeriod {
  monthly
  yearly
}

enum RecurringFrequency {
  daily
  weekly
  monthly
}

enum TradeSide {
  buy
  sell
}

enum ContributionType {
  deposit
  withdrawal
}

model Currency {
  id        String   @id @default(uuid(7))
  code      String   @unique
  name      String
  symbol    String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users                               User[]
  accounts                            Account[]
  investments                         Investment[]             @relation("InvestmentCurrency")
  investmentsBaseCurrency             Investment[]             @relation("InvestmentBaseCurrency")
  transactions                        Transaction[]
  recurringTransactions               RecurringTransaction[]
  investmentTrades                    InvestmentTrade[]
  investmentTradesBaseCurrency        InvestmentTrade[]        @relation("TradeBaseCurrency")
  investmentContributions             InvestmentContribution[]
  investmentContributionsBaseCurrency InvestmentContribution[] @relation("ContributionBaseCurrency")
  investmentValuations                InvestmentValuation[]
  investmentValuationsBaseCurrency    InvestmentValuation[]    @relation("ValuationBaseCurrency")

  @@index([code], name: "currency_code_idx")
  @@map("currencies")
}

model User {
  id             String    @id @default(uuid(7))
  username       String    @unique
  password       String
  name           String?
  role           UserRole  @default(user)
  baseCurrencyId String    @map("base_currency_id")
  settings       Json?
  deletedAt      DateTime? @map("deleted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  baseCurrency            Currency                 @relation(fields: [baseCurrencyId], references: [id], onDelete: Restrict)
  accounts                Account[]
  categories              Category[]
  investments             Investment[]
  transactions            Transaction[]
  investmentContributions InvestmentContribution[]
  investmentValuations    InvestmentValuation[]
  budgets                 Budget[]
  entities                Entity[]
  recurringTransactions   RecurringTransaction[]
  investmentTrades        InvestmentTrade[]
  holdings                Holding[]
  tags                    Tag[]
  events                  Event[]

  @@index([username], name: "user_username_idx")
  @@index([baseCurrencyId], name: "user_baseCurrencyId_idx")
  @@map("users")
}

model Account {
  id               String      @id @default(uuid(7))
  userId           String      @map("user_id")
  type             AccountType
  name             String
  currencyId       String      @map("currency_id")
  balance          Decimal     @default(0) @db.Decimal(30, 10)
  creditLimit      Decimal?    @map("credit_limit") @db.Decimal(30, 10)
  notifyOnDueDate  Boolean?    @map("notify_on_due_date")
  paymentDay       Int?        @map("payment_day")
  notifyDaysBefore Int?        @map("notify_days_before")
  meta             Json?
  deletedAt        DateTime?   @map("deleted_at")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  currency                Currency                 @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions            Transaction[]            @relation("AccountTransactions")
  toTransactions          Transaction[]            @relation("ToAccountTransactions")
  recurringTransactions   RecurringTransaction[]
  investmentTrades        InvestmentTrade[]
  investmentContributions InvestmentContribution[]

  @@index([userId], name: "account_userId_idx")
  @@index([type], name: "account_type_idx")
  @@index([currencyId], name: "account_currencyId_idx")
  @@map("accounts")
}

model Category {
  id        String       @id @default(uuid(7))
  userId    String       @map("user_id")
  type      CategoryType
  name      String
  parentId  String?      @map("parent_id")
  icon      String?
  color     String?
  isLocked  Boolean      @default(false) @map("is_locked")
  deletedAt DateTime?    @map("deleted_at")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent                Category?              @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children              Category[]             @relation("CategoryHierarchy")
  transactions          Transaction[]
  budgets               Budget[]
  recurringTransactions RecurringTransaction[]

  @@index([userId], name: "category_userId_idx")
  @@index([type], name: "category_type_idx")
  @@index([parentId], name: "category_parentId_idx")
  @@map("categories")
}

model Investment {
  id             String              @id @default(uuid(7))
  userId         String              @map("user_id")
  symbol         String
  name           String
  assetType      InvestmentAssetType @map("asset_type")
  mode           InvestmentMode      @default(priced)
  currencyId     String              @map("currency_id")
  baseCurrencyId String?             @map("base_currency_id")
  extra          Json?
  deletedAt      DateTime?           @map("deleted_at")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  currency      Currency                 @relation("InvestmentCurrency", fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency  Currency?                @relation("InvestmentBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)
  user          User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  trades        InvestmentTrade[]
  holdings      Holding[]
  contributions InvestmentContribution[]
  valuations    InvestmentValuation[]

  @@index([userId], name: "investment_userId_idx")
  @@index([assetType], name: "investment_assetType_idx")
  @@index([symbol], name: "investment_symbol_idx")
  @@index([currencyId], name: "investment_currencyId_idx")
  @@index([baseCurrencyId], name: "investment_baseCurrencyId_idx")
  @@map("investments")
}

model Transaction {
  id                  String          @id @default(uuid(7))
  userId              String          @map("user_id")
  accountId           String          @map("account_id")
  toAccountId         String?         @map("to_account_id")
  transferGroupId     String?         @map("transfer_group_id")
  isTransferMirror    Boolean         @default(false) @map("is_transfer_mirror")
  type                TransactionType
  categoryId          String?         @map("category_id")
  investmentId        String?         @map("investment_id")
  entityId            String?         @map("entity_id")
  eventId             String?         @map("event_id")
  amount              Decimal         @db.Decimal(30, 10)
  currencyId          String          @map("currency_id")
  price               Decimal?        @db.Decimal(30, 10)
  priceInBaseCurrency Decimal?        @map("price_in_base_currency") @db.Decimal(30, 10)
  quantity            Decimal?        @db.Decimal(30, 10)
  fee                 Decimal         @default(0) @db.Decimal(30, 10)
  feeInBaseCurrency   Decimal?        @map("fee_in_base_currency") @db.Decimal(30, 10)
  date                DateTime
  dueDate             DateTime?       @map("due_date")
  note                String?
  receiptUrl          String?         @map("receipt_url")
  metadata            Json?
  deletedAt           DateTime?       @map("deleted_at")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  currency   Currency         @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account    Account          @relation("AccountTransactions", fields: [accountId], references: [id], onDelete: Cascade)
  toAccount  Account?         @relation("ToAccountTransactions", fields: [toAccountId], references: [id], onDelete: SetNull)
  category   Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  investment Investment?      @relation(fields: [investmentId], references: [id], onDelete: SetNull)
  entity     Entity?          @relation(fields: [entityId], references: [id], onDelete: SetNull)
  event      Event?           @relation(fields: [eventId], references: [id], onDelete: SetNull)
  trade      InvestmentTrade? @relation("TransactionTrade")

  @@index([userId], name: "transaction_userId_idx")
  @@index([accountId], name: "transaction_accountId_idx")
  @@index([toAccountId], name: "transaction_toAccountId_idx")
  @@index([categoryId], name: "transaction_categoryId_idx")
  @@index([investmentId], name: "transaction_investmentId_idx")
  @@index([entityId], name: "transaction_entityId_idx")
  @@index([eventId], name: "transaction_eventId_idx")
  @@index([currencyId], name: "transaction_currencyId_idx")
  @@index([date], name: "transaction_date_idx")
  @@index([dueDate], name: "transaction_dueDate_idx")
  @@index([type], name: "transaction_type_idx")
  @@index([userId, date], name: "transaction_user_date_idx")
  @@index([userId, accountId, date], name: "transaction_user_account_date_idx")
  @@index([userId, investmentId, date], name: "transaction_user_investment_date_idx")
  @@index([transferGroupId], name: "transaction_transferGroupId_idx")
  @@map("transactions")
}

model Budget {
  id         String       @id @default(uuid(7))
  userId     String       @map("user_id")
  categoryId String       @map("category_id")
  amount     Decimal      @db.Decimal(30, 10)
  period     BudgetPeriod
  startDate  DateTime     @map("start_date")
  endDate    DateTime?    @map("end_date")
  deletedAt  DateTime?    @map("deleted_at")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId], name: "budget_userId_idx")
  @@index([categoryId], name: "budget_categoryId_idx")
  @@map("budgets")
}

model Entity {
  id        String     @id @default(uuid(7))
  userId    String     @map("user_id")
  name      String
  type      EntityType @default(individual)
  phone     String?
  email     String?
  address   String?
  note      String?
  deletedAt DateTime?  @map("deleted_at")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name], name: "entity_userId_name_unique")
  @@index([userId], name: "entity_userId_idx")
  @@index([name], name: "entity_name_idx")
  @@index([type], name: "entity_type_idx")
  @@map("entities")
}

model RecurringTransaction {
  id         String             @id @default(uuid(7))
  userId     String             @map("user_id")
  accountId  String             @map("account_id")
  categoryId String?            @map("category_id")
  type       TransactionType
  amount     Decimal            @db.Decimal(30, 10)
  currencyId String             @map("currency_id")
  frequency  RecurringFrequency
  nextDate   DateTime           @map("next_date")
  endDate    DateTime?          @map("end_date")
  note       String?
  createdAt  DateTime           @default(now()) @map("created_at")
  updatedAt  DateTime           @updatedAt @map("updated_at")

  currency Currency  @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId], name: "recurringTransaction_userId_idx")
  @@index([currencyId], name: "recurringTransaction_currencyId_idx")
  @@index([nextDate], name: "recurringTransaction_nextDate_idx")
  @@map("recurring_transactions")
}

model InvestmentTrade {
  id                   String    @id @default(uuid(7))
  userId               String    @map("user_id")
  investmentId         String    @map("investment_id")
  accountId            String    @map("account_id")
  side                 TradeSide
  timestamp            DateTime
  price                Decimal   @db.Decimal(30, 10)
  quantity             Decimal   @db.Decimal(30, 10)
  amount               Decimal   @db.Decimal(30, 10)
  fee                  Decimal   @default(0) @db.Decimal(30, 10)
  currencyId           String    @map("currency_id")
  priceCurrency        String?   @map("price_currency")
  priceInBaseCurrency  Decimal?  @map("price_in_base_currency") @db.Decimal(30, 10)
  amountInBaseCurrency Decimal?  @map("amount_in_base_currency") @db.Decimal(30, 10)
  exchangeRate         Decimal?  @map("exchange_rate") @db.Decimal(30, 10)
  baseCurrencyId       String?   @map("base_currency_id")
  priceSource          String?   @map("price_source")
  priceFetchedAt       DateTime? @map("price_fetched_at")
  externalId           String?   @map("external_id")
  transactionId        String?   @unique @map("transaction_id")
  meta                 Json?
  deletedAt            DateTime? @map("deleted_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  currency     Currency     @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency Currency?    @relation("TradeBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  investment   Investment   @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  transaction  Transaction? @relation("TransactionTrade", fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([userId, investmentId], name: "trade_user_investment_idx")
  @@index([investmentId, timestamp], name: "trade_investment_time_idx")
  @@index([currencyId], name: "trade_currencyId_idx")
  @@index([externalId], name: "trade_externalId_idx")
  @@index([baseCurrencyId], name: "trade_baseCurrencyId_idx")
  @@map("investment_trades")
}

model InvestmentContribution {
  id                   String           @id @default(uuid(7))
  userId               String           @map("user_id")
  investmentId         String           @map("investment_id")
  accountId            String?          @map("account_id")
  amount               Decimal          @db.Decimal(30, 10)
  currencyId           String           @map("currency_id")
  type                 ContributionType @default(deposit)
  amountInBaseCurrency Decimal?         @map("amount_in_base_currency") @db.Decimal(30, 10)
  exchangeRate         Decimal?         @map("exchange_rate") @db.Decimal(30, 10)
  baseCurrencyId       String?          @map("base_currency_id")
  timestamp            DateTime
  note                 String?
  deletedAt            DateTime?        @map("deleted_at")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  account      Account?   @relation(fields: [accountId], references: [id], onDelete: SetNull)
  currency     Currency   @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency Currency?  @relation("ContributionBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)

  @@index([userId], name: "investmentContribution_userId_idx")
  @@index([investmentId], name: "investmentContribution_investmentId_idx")
  @@index([accountId], name: "investmentContribution_accountId_idx")
  @@index([currencyId], name: "investmentContribution_currencyId_idx")
  @@index([baseCurrencyId], name: "investmentContribution_baseCurrencyId_idx")
  @@map("investment_contributions")
}

model InvestmentValuation {
  id                  String    @id @default(uuid(7))
  userId              String    @map("user_id")
  investmentId        String    @map("investment_id")
  currencyId          String    @map("currency_id")
  price               Decimal   @db.Decimal(30, 10)
  priceInBaseCurrency Decimal?  @map("price_in_base_currency") @db.Decimal(30, 10)
  exchangeRate        Decimal?  @map("exchange_rate") @db.Decimal(30, 10)
  baseCurrencyId      String?   @map("base_currency_id")
  timestamp           DateTime
  source              String?
  fetchedAt           DateTime? @map("fetched_at")
  deletedAt           DateTime? @map("deleted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  currency     Currency   @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency Currency?  @relation("ValuationBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)

  @@index([userId], name: "investmentValuation_userId_idx")
  @@index([investmentId], name: "investmentValuation_investmentId_idx")
  @@index([currencyId], name: "investmentValuation_currencyId_idx")
  @@index([timestamp], name: "investmentValuation_timestamp_idx")
  @@index([baseCurrencyId], name: "investmentValuation_baseCurrencyId_idx")
  @@map("investment_valuations")
}

model Holding {
  id                     String    @id @default(uuid(7))
  userId                 String    @map("user_id")
  investmentId           String    @map("investment_id")
  quantity               Decimal   @db.Decimal(30, 10)
  avgCost                Decimal   @map("avg_cost") @db.Decimal(30, 10)
  unrealizedPnl          Decimal?  @map("unrealized_pnl") @db.Decimal(30, 10)
  unrealizedPnlUpdatedAt DateTime? @map("unrealized_pnl_updated_at")
  lastPrice              Decimal?  @map("last_price") @db.Decimal(30, 10)
  lastPriceAt            DateTime? @map("last_price_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([userId, investmentId], name: "holding_user_investment_idx")
  @@map("holdings")
}

model Tag {
  id          String    @id @default(uuid(7))
  userId      String    @map("user_id")
  name        String
  description String?
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name], name: "tag_userId_name_unique")
  @@index([userId], name: "tag_userId_idx")
  @@index([name], name: "tag_name_idx")
  @@map("tags")
}

model Event {
  id        String    @id @default(uuid(7))
  userId    String    @map("user_id")
  name      String
  startAt   DateTime  @map("start_at")
  endAt     DateTime? @map("end_at")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name], name: "event_userId_name_unique")
  @@index([userId], name: "event_userId_idx")
  @@index([name], name: "event_name_idx")
  @@index([startAt], name: "event_startAt_idx")
  @@index([endAt], name: "event_endAt_idx")
  @@map("events")
}
