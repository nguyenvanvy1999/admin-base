// User financial accounts (cash, bank, credit card, investment)
model Account {
  id               String      @id
  userId           String      @map("user_id")
  type             AccountType
  name             String
  currencyId       String      @map("currency_id")
  balance          Decimal     @default(0) @db.Decimal(30, 10)
  creditLimit      Decimal?    @map("credit_limit") @db.Decimal(30, 10)
  notifyOnDueDate  Boolean?    @map("notify_on_due_date")
  paymentDay       Int?        @map("payment_day")
  notifyDaysBefore Int?        @map("notify_days_before")
  meta             Json?
  created          DateTime    @default(now())
  modified         DateTime    @updatedAt

  currency                Currency                 @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions            Transaction[]            @relation("AccountTransactions")
  toTransactions          Transaction[]            @relation("ToAccountTransactions")
  recurringTransactions   RecurringTransaction[]
  investmentTrades        InvestmentTrade[]
  investmentContributions InvestmentContribution[]
  budgetAccounts          BudgetAccount[]
  goalAccounts            GoalAccount[]

  @@index([userId], name: "account_userId_idx")
  @@index([type], name: "account_type_idx")
  @@index([currencyId], name: "account_currencyId_idx")
  @@map("accounts")
}

// Hierarchical categories for organizing transactions
model Category {
  id       String       @id
  userId   String       @map("user_id")
  type     CategoryType
  name     String
  parentId String?      @map("parent_id")
  icon     String?
  color    String?
  isLocked Boolean      @default(false) @map("is_locked")

  created  DateTime @default(now())
  modified DateTime @updatedAt

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent                Category?              @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children              Category[]             @relation("CategoryHierarchy")
  transactions          Transaction[]
  budgets               Budget[]
  budgetCategories      BudgetCategory[]
  recurringTransactions RecurringTransaction[]

  @@unique([userId, name, type], name: "category_userId_name_type_unique")
  @@index([userId], name: "category_userId_idx")
  @@index([type], name: "category_type_idx")
  @@index([parentId], name: "category_parentId_idx")
  @@map("categories")
}

// Core financial transaction records
model Transaction {
  id                  String          @id
  userId              String          @map("user_id")
  accountId           String          @map("account_id")
  toAccountId         String?         @map("to_account_id")
  transferGroupId     String?         @map("transfer_group_id")
  isTransferMirror    Boolean         @default(false) @map("is_transfer_mirror")
  type                TransactionType
  categoryId          String          @map("category_id")
  investmentId        String?         @map("investment_id")
  entityId            String?         @map("entity_id")
  eventId             String?         @map("event_id")
  amount              Decimal         @db.Decimal(30, 10)
  currencyId          String          @map("currency_id")
  price               Decimal?        @db.Decimal(30, 10)
  priceInBaseCurrency Decimal?        @map("price_in_base_currency") @db.Decimal(30, 10)
  quantity            Decimal?        @db.Decimal(30, 10)
  fee                 Decimal         @default(0) @db.Decimal(30, 10)
  feeInBaseCurrency   Decimal?        @map("fee_in_base_currency") @db.Decimal(30, 10)
  date                DateTime
  dueDate             DateTime?       @map("due_date")
  note                String?
  receiptUrl          String?         @map("receipt_url")
  metadata            Json?
  created             DateTime        @default(now())
  modified            DateTime        @updatedAt

  currency   Currency         @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account    Account          @relation("AccountTransactions", fields: [accountId], references: [id], onDelete: Cascade)
  toAccount  Account?         @relation("ToAccountTransactions", fields: [toAccountId], references: [id], onDelete: SetNull)
  category   Category         @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  investment Investment?      @relation(fields: [investmentId], references: [id], onDelete: SetNull)
  entity     Entity?          @relation(fields: [entityId], references: [id], onDelete: SetNull)
  event      Event?           @relation(fields: [eventId], references: [id], onDelete: SetNull)
  trade      InvestmentTrade? @relation("TransactionTrade")

  @@index([userId], name: "transaction_userId_idx")
  @@index([accountId], name: "transaction_accountId_idx")
  @@index([toAccountId], name: "transaction_toAccountId_idx")
  @@index([categoryId], name: "transaction_categoryId_idx")
  @@index([investmentId], name: "transaction_investmentId_idx")
  @@index([entityId], name: "transaction_entityId_idx")
  @@index([eventId], name: "transaction_eventId_idx")
  @@index([currencyId], name: "transaction_currencyId_idx")
  @@index([date], name: "transaction_date_idx")
  @@index([dueDate], name: "transaction_dueDate_idx")
  @@index([type], name: "transaction_type_idx")
  @@index([userId, date], name: "transaction_user_date_idx")
  @@index([userId, accountId, date], name: "transaction_user_account_date_idx")
  @@index([userId, investmentId, date], name: "transaction_user_investment_date_idx")
  @@index([transferGroupId], name: "transaction_transferGroupId_idx")
  @@map("transactions")
}

// Scheduled recurring transactions (subscriptions, salaries, etc.)
model RecurringTransaction {
  id         String             @id
  userId     String             @map("user_id")
  accountId  String             @map("account_id")
  categoryId String?            @map("category_id")
  type       TransactionType
  amount     Decimal            @db.Decimal(30, 10)
  currencyId String             @map("currency_id")
  frequency  RecurringFrequency
  nextDate   DateTime           @map("next_date")
  endDate    DateTime?          @map("end_date")
  note       String?
  created    DateTime           @default(now())
  modified   DateTime           @updatedAt

  currency Currency  @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId], name: "recurringTransaction_userId_idx")
  @@index([currencyId], name: "recurringTransaction_currencyId_idx")
  @@index([nextDate], name: "recurringTransaction_nextDate_idx")
  @@map("recurring_transactions")
}
