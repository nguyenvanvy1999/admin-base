model Budget {
  id              String       @id
  userId          String       @map("user_id")
  name            String
  amount          Decimal      @db.Decimal(30, 10)
  period          BudgetPeriod
  startDate       DateTime     @map("start_date")
  endDate         DateTime?    @map("end_date")
  carryOver       Boolean      @default(false) @map("carry_over")
  anchorAccountId String?      @map("anchor_account_id")
  metadata        Json?
  created         DateTime     @default(now())
  modified        DateTime     @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  anchorAccount LedgerAccount?    @relation(fields: [anchorAccountId], references: [id], onDelete: SetNull)
  ledgerScopes  BudgetLedgerScope[]
  fundingScopes BudgetFundingScope[]
  periods       BudgetPeriodRecord[]

  @@index([userId], name: "budget_userId_idx")
  @@map("budgets")
}

model BudgetLedgerScope {
  id              String        @id @default(uuid(7))
  budgetId        String        @map("budget_id")
  ledgerAccountId String        @map("ledger_account_id")
  weight          Decimal?      @db.Decimal(10, 5)
  created         DateTime      @default(now())

  budget        Budget        @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  ledgerAccount LedgerAccount @relation(fields: [ledgerAccountId], references: [id], onDelete: Cascade)

  @@unique([budgetId, ledgerAccountId], name: "budget_ledger_scope_unique")
  @@index([ledgerAccountId], name: "budget_ledger_scope_account_idx")
  @@map("budget_ledger_scopes")
}

model BudgetFundingScope {
  id              String        @id @default(uuid(7))
  budgetId        String        @map("budget_id")
  ledgerAccountId String        @map("ledger_account_id")
  allocation      Decimal?      @db.Decimal(30, 10)
  created         DateTime      @default(now())

  budget        Budget        @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  ledgerAccount LedgerAccount @relation(fields: [ledgerAccountId], references: [id], onDelete: Cascade)

  @@unique([budgetId, ledgerAccountId], name: "budget_funding_scope_unique")
  @@index([ledgerAccountId], name: "budget_funding_scope_account_idx")
  @@map("budget_funding_scopes")
}

model BudgetPeriodRecord {
  id                String   @id
  budgetId          String   @map("budget_id")
  periodStartDate   DateTime @map("period_start_date")
  periodEndDate     DateTime @map("period_end_date")
  carriedOverAmount Decimal  @default(0) @map("carried_over_amount") @db.Decimal(30, 10)
  created           DateTime @default(now())
  modified          DateTime @updatedAt

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@unique([budgetId, periodStartDate], name: "budget_period_unique")
  @@index([budgetId], name: "budget_period_budgetId_idx")
  @@index([periodStartDate], name: "budget_period_startDate_idx")
  @@map("budget_periods")
}
